<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Alpha Token Volume Board</title>
    <style>
        :root {
            --bg: #f9fafb;
            --text: #1f2937;
            --sub: #6b7280;
            --border: #e5e7eb;
            --green: #16a34a;
            --red: #dc2626;
            --primary: #2563eb
        }

        @media(prefers-color-scheme:dark) {
            :root {
                --bg: #1e293b;
                --text: #f3f4f6;
                --sub: #9ca3af;
                --border: #334155
            }
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0
        }

        body {
            font-family: -apple-system, "Segoe UI", "PingFang SC", sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5
        }

        h1 {
            padding: 18px 12px;
            text-align: center;
            font-size: 1.35rem;
            color: var(--primary)
        }

        /* 最后更新时间 */
        .last-up {
            text-align: center;
            font-size: .8rem;
            color: var(--sub);
            margin-top: -6px;
            margin-bottom: 12px
        }

        /* ---------- 顶栏 ---------- */
        #bar {
            max-width: 1200px;
            margin: 0 auto 12px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 8px;
            padding: 0 6px
        }

        #bar-left {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: flex-start;
        }

        #bar-left input[type="search"] {
            flex: 1;
            min-width: 160px
        }

        #bar-left input[type="text"] {
            width: 120px
        }

        #bar-left input[type="number"] {
            width: 40px;
        }

        #bar-left input[type="checkbox"] {
            width: auto;
            /* 不要强制宽度 */
            padding: 0;
            /* 去掉内边距 */
            margin: 0;
            /* 去掉外边距 */
            vertical-align: middle;
            /* 垂直对齐文字 */
            border: none;
            /* 去掉边框 */
        }


        #bar-left input[type="datetime-local"] {
            width: 190px
        }

        #bar-left input {
            padding: 6px 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: .85rem
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            font-size: .85rem;
            border: 1px solid var(--primary);
            color: #fff;
            background: var(--primary);
            border-radius: 4px;
            cursor: pointer
        }

        .btn[disabled] {
            background: #9ca3af;
            border-color: #9ca3af;
            cursor: not-allowed
        }

        .badge {
            /* 仅用于进度百分比 */
            display: none;
            padding: 0 6px;
            border-radius: 10px;
            font-size: .7rem;
            font-weight: 700;
            background: #fff;
            color: var(--primary)
        }

        /* Star */
        .star {
            cursor: pointer;
            font-size: 1rem;
            color: var(--sub);
            user-select: none;
            transition: transform .15s, color .15s
        }

        .star.fav {
            color: #f7b500
        }

        .star.bounce {
            transform: scale(1.4)
        }

        #author {
            font-size: .8rem;
            white-space: nowrap
        }

        #author a {
            color: var(--primary);
            text-decoration: none
        }

        /* 新增：过滤开关 */
        .chk {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: .85rem;
            color: var(--text);
            user-select: none
        }

        /* ---------- 广告位 ---------- */
        .ad {
            max-width: 1200px;
            margin: 0 auto 10px;
            padding: 8px 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            border: 1px dashed var(--border);
            border-radius: 6px;
            background: rgba(0, 0, 0, .02)
        }

        .ad-badge {
            font-size: .68rem;
            padding: 0 6px;
            border-radius: 8px;
            color: #fff;
            background: #6b7280
        }

        .ad-note {
            font-size: .82rem;
            color: var(--primary)
        }

        .ad-links {
            margin-left: auto;
            display: flex;
            gap: 8px;
            flex-wrap: wrap
        }

        .ad .btn {
            padding: 6px 10px
        }

        /* ✅ 新增：Telegram 徽章 */
        .tg-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: .75rem;
            padding: 2px 8px;
            border-radius: 10px;
            color: #fff;
            background: #229ED9;
            text-decoration: none;
            line-height: 1.6
        }

        .tg-badge:hover {
            opacity: .9
        }

        .tg-badge .icon {
            font-size: .9rem;
            line-height: 1
        }

        /* ---------- 表格 ---------- */
        table {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            border-collapse: collapse;
            min-width: 620px
        }

        th,
        td {
            padding: 10px 6px;
            border-bottom: 1px solid var(--border);
            font-size: .85rem;
            text-align: left;
            white-space: nowrap
        }

        tbody tr:hover {
            background: rgba(0, 0, 0, .04);
            cursor: pointer
        }

        th.sortable {
            cursor: pointer;
            user-select: none;
            position: relative
        }

        th.sortable::after {
            content: '▲';
            position: absolute;
            right: 4px;
            font-size: .6rem;
            color: var(--sub);
            transform: scale(.8);
            opacity: 0;
            transition: opacity .2s
        }

        th.sortable.desc::after {
            content: '▼';
            opacity: 1
        }

        th.sortable.asc::after {
            content: '▲';
            opacity: 1
        }

        /* 颜色 & 小字 */
        .logo {
            width: 18px;
            height: 18px;
            margin-right: 4px;
            vertical-align: middle;
            border-radius: 50%
        }

        .up {
            color: var(--green)
        }

        .down {
            color: var(--red)
        }

        .subl {
            display: block;
            font-size: .72rem;
            color: var(--sub)
        }

        /* 新增：30天内上新标记 */
        .tag-new {
            display: inline-block;
            margin-left: 6px;
            padding: 0 6px;
            border-radius: 10px;
            font-size: .68rem;
            line-height: 1.4;
            border: 1px solid var(--primary);
            color: var(--primary);
            background: rgba(37, 99, 235, .08)
        }

        /* Toast */
        #toast {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, .8);
            color: #fff;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: .85rem;
            opacity: 0;
            pointer-events: none;
            transition: opacity .3s
        }

        /* 自定义区间结果 */
        #customVol {
            max-width: 1200px;
            margin: 4px auto 0;
            font-size: .9rem;
            color: var(--primary)
        }

        footer {
            height: 16px;
            margin-bottom: 12px
        }

        @media(max-width:760px) {
            #bar-left input[type="datetime-local"] {
                flex: 1;
                min-width: 140px
            }

            .ad-links {
                width: 100%;
                justify-content: flex-start;
                margin-left: 0
            }
        }


        /* 新增：表单行样式 */
        .form-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .form-row label {
            white-space: nowrap;
        }

        .form-row input:not([type="checkbox"]),
        .form-row select {
            min-width: 75px;
            flex: 1;
        }

        .form-row input[type="checkbox"] {
            flex: 0;
            /* 不占空间 */
            min-width: 10px;
            /* 不要强制宽度 */
            width: auto;
            /* 恢复原始宽度 */
        }
    </style>
    <!-- 1. Add Lightweight Charts CDN in <head> (if not already included) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>Binance&nbsp;Alpha&nbsp;—&nbsp;&nbsp;稳定排行榜</h1>
    <p id="lastUp" class="last-up"></p>

    <div id="bar">
        <div id="bar-left">


            <div class="form-row">
                <label for="interval">时间间隔:</label>
                <select id="interval">
                    <option value="1s">1秒</option>
                    <option value="15s" selected>15秒</option>
                    <option value="1m">1分钟</option>
                    <option value="3m">3分钟</option>
                    <option value="5m">5分钟</option>
                    <option value="15m">15分钟</option>
                    <option value="30m">30分钟</option>
                    <option value="1h">1小时</option>
                    <option value="2h">2小时</option>
                    <option value="4h">4小时</option>
                    <option value="6h">6小时</option>
                    <option value="8h">8小时</option>
                    <option value="12h">12小时</option>
                    <option value="1d">1天</option>
                    <option value="3d">3天</option>
                    <option value="1w">1周</option>
                    <option value="1M">1月</option>
                </select>
            </div>
            <div class="form-row">
                <label for="limit">请求数据数量 (最大1500):</label>
                <input type="number" id="limit" value="20" placeholder="例如: 100" min="1" max="1500">
            </div>
            <div class="form-row">
                <label for="meanPriceRatioThreshold">收盘/开盘比 均值 -1 &lt; </label>
                <input type="number" id="meanPriceRatioThreshold" value="1e-5" step="1e-5" placeholder="例如: 1e-5"
                    min="0">
            </div>
            <div class="form-row">
                <label for="openVarianceThreshold">开盘价方差 &lt; </label>
                <input type="number" id="openVarianceThreshold" value="8e-4" step="1e-4" placeholder="例如: 1e-4" min="0">
            </div>
            <div class="form-row">
                <label for="closeVarianceThreshold">收盘价方差 &lt; </label>
                <input type="number" id="closeVarianceThreshold" value="8e-4" step="1e-4" placeholder="例如: 1e-4"
                    min="0">
            </div>
            <div class="form-row">
                <label for="tradeVolumePerMinute">每分钟成交量 &gt; </label>
                <input type="number" id="tradeVolumePerMinute" value="5e5" step="1e5" placeholder="例如: 100000"
                    min="1e5">
            </div>

            <div class="form-row">
                <label for="tradeVolumeVarianceThreshold">成交量方差 &lt; </label>
                <input type="number" id="tradeVolumeVarianceThreshold" value="0.3" step="0.1" placeholder="例如: 1000000"
                    min="0.3">
            </div>

            <button id="refreshBtn" class="btn"> ⟳ 刷新数据 <span id="progress" class="badge">0%</span> </button>

            <button id="btn10min" class="btn" type="button">看10分钟 1分钟级别波动</button>
            <button id="btn5min" class="btn" type="button">看5分钟 15秒级别波动</button>
            <button id="btn3min" class="btn" type="button">看3分钟 1秒级别波动</button>
            <div class="form-row">
                <input type="checkbox" id="showKoge" checked>
                <label for="showKoge">是否显示KOGE</label>
            </div>


        </div>
    </div>

    <div id="customVol"></div>

    <table id="tokenTable">
        <thead>
            <tr>
                <th style="width:26px"></th>
                <th>代币名字</th>
                <th id="thPrice" class="sortable" data-key="price">价格</th>
                <th>走势</th> <!-- 新增：图表表头 -->
                <th id="thVol24h" class="sortable" data-key="vol24h">24H 成交量</th>
                <th class="sortable" data-key="chg">24H 变化</th>
                <th class="sortable" data-key="totalQuoteVolume">总成交量<span class="subl"></span>
                </th>
                <th class="sortable" data-key="tradeVolumeVariance">成交量方差<span class="subl"></span></th>
                <th class="sortable" data-key="meanPriceRatioFactor">收盘/开盘比 均值 -1<span class="subl"></span>
                </th>
                <th class="sortable" data-key="ratioVariance">收盘/开盘比方差<span class="subl"></span></th>
                <th class="sortable" data-key="openVariance">开盘价方差<span class="subl"></span></th>
                <th class="sortable" data-key="closeVariance">收盘价方差<span class="subl"></span></th>
                <th class="sortable" data-key="meanOpenPrice">均值开盘价<span class="subl"></span></th>
                <th class="sortable" data-key="meanClosePrice">均值收盘价<span class="subl"></span></th>
                <th id="thToday" class="sortable" data-key="todayQV">当天限价单成交额</th>
                <th id="thPrev" class="sortable" data-key="prevQV">前一天限价单成交额</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td colspan="8">加载中…</td>
            </tr>
        </tbody>
    </table>

    <div id="toast"></div>
    <footer></footer>

    <script>
        document.getElementById('btn3min').onclick = function () {
            document.getElementById('interval').value = '1s';
            document.getElementById('limit').value = 180;
            updateTotalVolDesc();
            document.getElementById('refreshBtn').click();
        };
        document.getElementById('btn5min').onclick = function () {
            document.getElementById('interval').value = '15s';
            document.getElementById('limit').value = 20;
            updateTotalVolDesc();
            document.getElementById('refreshBtn').click();
        };
        document.getElementById('btn10min').onclick = function () {
            document.getElementById('interval').value = '1m';
            document.getElementById('limit').value = 10;
            updateTotalVolDesc();
            document.getElementById('refreshBtn').click();
        };
    </script>

    <script>
        function intervalToMs(interval) {
            const map = { s: 1000, m: 60000, h: 3600000, d: 86400000, w: 604800000, M: 2592000000 };
            const match = interval.match(/^(\d+)([smhdwM])$/);
            if (!match) return 0;
            return parseInt(match[1]) * (map[match[2]] || 0);
        }
        function msToHuman(ms) {
            if (ms < 60000) return `${ms / 1000}秒`;
            if (ms < 3600000) return `${Math.round(ms / 60000)}分钟`;
            if (ms < 86400000) return `${Math.round(ms / 3600000)}小时`;
            if (ms < 2592000000) return `${Math.round(ms / 86400000)}天`;
            return `${Math.round(ms / 2592000000)}月`;
        }
        function updateTotalVolDesc() {
            const interval = document.getElementById('interval').value;
            const limit = parseInt(document.getElementById('limit').value) || 0;
            const ms = intervalToMs(interval) * limit;
            const desc = ms ? `(${msToHuman(ms)})` : '';

            // Update all .subl spans in thead except those for 24H/prev/today
            const thead = document.querySelector('#tokenTable thead');
            thead.querySelectorAll('.subl').forEach(span => {
                // Only update if not inside thVol24h, thToday, thPrev
                const th = span.closest('th');
                if (th && !['thVol24h', 'thToday', 'thPrev'].includes(th.id)) {
                    span.textContent = desc;
                }
            });
        }
        document.getElementById('interval').addEventListener('change', updateTotalVolDesc);
        document.getElementById('limit').addEventListener('input', updateTotalVolDesc);
        updateTotalVolDesc();
    </script>

    <script>
        /* ---------- 常量 & 工具 ---------- */
        const LIST_API = 'https://www.binance.com/bapi/defi/v1/public/wallet-direct/buw/wallet/cex/alpha/all/token/list';
        const K_API = 'https://www.binance.com/bapi/defi/v1/public/alpha-trade/klines';
        const nf0 = new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 });
        const nf5 = new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 5 });
        const CONCURRENCY = 5;
        const THIRTY_DAYS = 29 * 24 * 60 * 60 * 1000; // 30 days in milliseconds

        const fmtShort = ts => new Intl.DateTimeFormat('zh-CN', {
            timeZone: 'Asia/Shanghai', hour12: false, month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
        }).format(new Date(ts)).replace(/\//g, '-');

        const fmtFull = ts => new Intl.DateTimeFormat('zh-CN', {
            timeZone: 'Asia/Shanghai', hour12: false, year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit', second: '2-digit'
        }).format(new Date(ts)).replace(/\//g, '-');

        const nearest8UTC = () => {
            const n = new Date(), b = new Date();
            b.setHours(8, 0, 0, 0);
            if (n < b) b.setDate(b.getDate() - 1);
            return b.getTime();
        };

        /* ---------- DOM ---------- */
        const tbody = document.querySelector('#tokenTable tbody');
        const refreshBtn = document.getElementById('refreshBtn');
        const progressEl = document.getElementById('progress');
        const lastUpEl = document.getElementById('lastUp');
        const thToday = document.getElementById('thToday');
        const thPrev = document.getElementById('thPrev');
        const toast = document.getElementById('toast');


        /* ---------- Toast ---------- */
        function showToast(msg) {
            toast.textContent = msg; toast.style.opacity = '1';
            setTimeout(() => toast.style.opacity = '0', 3000);
        }

        /* ---------- 状态 ---------- */
        let rows = [], filter = '', sortKey = 'todayQV', sortDir = 'desc', showNewOnly = false;
        window._boundary = nearest8UTC();

        /* ---------- 并发限制 ---------- */
        function pLimit(n) {
            const q = []; let run = 0;
            const next = () => { if (run >= n || !q.length) return; run++; q.shift()().finally(() => { run--; next(); }); };
            return fn => new Promise(res => { q.push(() => fn().then(res)); next(); });
        }
        const limit = pLimit(CONCURRENCY);

        /* ---------- Quote Volume ---------- */
        async function qv(sym, start, end) {
            if (start >= end) return 0;
            const url = `${K_API}?symbol=${sym}&interval=1h&startTime=${start}&endTime=${end}&limit=1500`;
            try {
                const { data = [] } = await fetch(url).then(r => r.json());
                return data.reduce((s, k) => s + parseFloat(k[7]), 0);
            } catch { return 0; }
        }

        // Modified fillQVAll to also fetch 15s data and other statistics
        async function fillQVAll(list, today8, yest8, endTs) {
            let done = 0, total = list.length;
            progressEl.style.display = 'inline-block';
            await Promise.all(list.map(r => limit(async () => {
                // Fetch volume data first
                [r.todayQV, r.prevQV] = await Promise.all([
                    qv(r.sym, today8, endTs),
                    qv(r.sym, yest8, today8 - 1)
                ]);
                progressEl.textContent = `${Math.floor(++done / total * 100)}%`;
            })));
            progressEl.style.display = 'none';
        }


        // Modified fillQVAll to also fetch 15s data and other statistics
        async function fillMeanAll(list) {
            let done = 0, total = list.length;
            progressEl.style.display = 'inline-block';
            await Promise.all(list.map(r => limit(async () => {

                // 获取用户输入的时间间隔和数量
                const userInterval = document.getElementById('interval').value;
                const userLimit = document.getElementById('limit').value;

                // 如果用户没有输入，则使用默认值
                const interval = userInterval || '15s';
                const limit = userLimit ? Math.min(parseInt(userLimit), 1500) : 100; // 限制最大数量为1500


                // Fetch 15s Kline data for each token and calculate the necessary stats
                const klineData = await fetch15sData(r.sym, interval, limit);
                const {
                    meanOpenPrice,
                    meanClosePrice,
                    totalQuoteVolume,
                    tradeVolumeVariance,
                    openVariance,
                    closeVariance,
                    ratioVariance,
                    meanPriceRatioFactor
                } = calculateMeanData(klineData);

                // Populate additional data in the token object
                r.meanOpenPrice = meanOpenPrice;
                r.meanClosePrice = meanClosePrice;
                r.totalQuoteVolume = totalQuoteVolume;
                r.tradeVolumeVariance = tradeVolumeVariance;
                r.openVariance = openVariance;
                r.closeVariance = closeVariance;
                r.ratioVariance = ratioVariance;
                r.meanPriceRatioFactor = meanPriceRatioFactor;


                // Fill the klines object
                klineData.forEach(kline => {
                    r.klines.opens.push(parseFloat(kline[1]));   // Open price
                    r.klines.closes.push(parseFloat(kline[4]));  // Close price
                    r.klines.highs.push(parseFloat(kline[2]));   // High price
                    r.klines.lows.push(parseFloat(kline[3]));    // Low price
                    r.klines.volumes.push(parseFloat(kline[5])); // Volume
                    r.klines.timestamps.push(parseInt(kline[0])); // Open time (timestamp)
                });
                progressEl.textContent = `${Math.floor(++done / total * 100)}%`;
            })));
            progressEl.style.display = 'none';
        }


        async function fetch15sData(symbol, interval = '15s', limit = 100) {
            const data = [];

            // Fetch the latest 100 data points
            const url = `${K_API}?symbol=${symbol}&interval=${interval}&limit=${limit}`;
            try {
                const { data: klineData } = await fetch(url).then(r => r.json());
                if (klineData && klineData.length > 0) {
                    data.push(...klineData);
                }
            } catch (error) {
                console.error('Error fetching Kline data:', error);
            }

            return data;
        }

        function calculateCV(values) {
            if (values.length === 0) return 0;

            const mean = values.reduce((sum, val) => sum + val, 0) / values.length;
            if (mean === 0) return 0;

            const variance = values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / values.length;
            const stdDev = Math.sqrt(variance);

            return stdDev / mean;
        }

        function calculateMeanData(klineData) {
            const tradeVolumes = klineData.map(d => parseFloat(d[7]));
            const openPrices = klineData.map(d => parseFloat(d[1]));
            const closePrices = klineData.map(d => parseFloat(d[4]));

            if (openPrices.some(isNaN) || closePrices.some(isNaN)) {
                return {
                    meanOpenPrice: 0,
                    meanClosePrice: 0,
                    totalQuoteVolume: 0,
                    tradeVolumeVariance: 0,
                    openVariance: 0,
                    closeVariance: 0,
                    ratioVariance: 0,
                    meanPriceRatioFactor: 0
                };
            }

            const priceRatios = openPrices.map((open, index) => {
                return open !== 0 ? closePrices[index] / open : 0;
            });

            const meanOpenPrice = openPrices.reduce((sum, price) => sum + price, 0) / openPrices.length;
            const meanClosePrice = closePrices.reduce((sum, price) => sum + price, 0) / closePrices.length;

            const totalQuoteVolume = klineData.reduce((sum, data) => sum + parseFloat(data[7]), 0);
            const tradeVolumeVariance = tradeVolumes.length > 1
                ? calculateCV(tradeVolumes.slice(0, -1))
                : 0;


            const openVariance = openPrices.length > 1 ? calculateCV(openPrices) : 0;
            const closeVariance = closePrices.length > 1 ? calculateCV(closePrices) : 0;

            const ratioVariance = priceRatios.length > 1 && priceRatios.some(r => r !== 0)
                ? calculateCV(priceRatios)
                : 0;

            const meanPriceRatioFactor = Math.abs(priceRatios.reduce((sum, priceRatio) => sum + priceRatio, 0) / priceRatios.length - 1);

            return {
                meanOpenPrice,
                meanClosePrice,
                totalQuoteVolume,
                tradeVolumeVariance,
                openVariance,
                closeVariance,
                ratioVariance,
                meanPriceRatioFactor
            };
        }

        /* ---------- 拉取列表（过滤仅30天内上新） ---------- */
        async function fetchList() {
            const resp = await fetch(LIST_API);
            if (!resp.ok) throw new Error('LIST_API Error');
            const { data = [] } = await resp.json();

            const sortedList = data
                .filter(t => +t.volume24h > 0)
                .map(t => {
                    const raw = Number(t.listingTime || 0);
                    const ltMs = raw ? (raw < 1e12 ? raw * 1000 : raw) : 0;
                    const isNew = ltMs ? (Date.now() - ltMs) <= THIRTY_DAYS : false;

                    // 预先计算剩余天数
                    let daysLeft = 0, showDaysLeft = false;
                    if (ltMs) {
                        const expire = ltMs + 29 * 24 * 60 * 60 * 1000;
                        const diffMs = expire - Date.now();
                        daysLeft = diffMs / (24 * 60 * 60 * 1000);
                        showDaysLeft = daysLeft > 0 && daysLeft < 5;
                    }

                    return {
                        price: +t.price,
                        vol24h: +t.volume24h,
                        chg: +t.percentChange24h,
                        symbol: t.symbol,
                        icon: t.iconUrl,
                        sym: `${t.alphaId}USDT`,
                        todayQV: 0,
                        prevQV: 0,
                        listingTime: ltMs,
                        listingTimeFmt: ltMs ? fmtFull(ltMs) : '',
                        isNew,
                        meanOpenPrice: 0,
                        meanClosePrice: 0,
                        totalQuoteVolume: 0,
                        tradeVolumeVariance: 0,
                        openVariance: 0,
                        closeVariance: 0,
                        ratioVariance: 0,
                        meanPriceRatioFactor: 0,
                        klines: {
                            opens: [],
                            closes: [],
                            highs: [],
                            lows: [],
                            volumes: [],
                            timestamps: [],
                        },
                        daysLeft,
                        showDaysLeft
                    };
                })
                .filter(t => t.isNew || (t.symbol.toLowerCase() === "koge" && document.getElementById('showKoge').checked)); // Only include tokens listed within the last 30 days

            // Sort the list by todayQV and take top 15
            return sortedList;
        }

        /* ---------- 排序 & 渲染 ---------- */
        function sortRows(arr) {
            return [...arr].sort((a, b) => sortDir === 'desc' ? b[sortKey] - a[sortKey] : a[sortKey] - b[sortKey]);
        }
        function updateSortIcons() {
            document.querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('asc', 'desc');
                if (th.dataset.key === sortKey) th.classList.add(sortDir);
            });
        }

        function render() {
            top15 = sortRows(top15)


            const meanPriceRatioThreshold = parseFloat(document.getElementById('meanPriceRatioThreshold').value) || 0;
            const tradeVolumeVarianceThreshold = parseFloat(document.getElementById('tradeVolumeVarianceThreshold').value) || 0;
            const openVarianceThreshold = parseFloat(document.getElementById('openVarianceThreshold').value) || 0;
            const closeVarianceThreshold = parseFloat(document.getElementById('closeVarianceThreshold').value) || 0;
            const tradeVolumePerMinute = parseFloat(document.getElementById('tradeVolumePerMinute').value) || 0;

            // filter out by totalQuoteVolume threshold
            const displayList = top15.filter(t => t.totalQuoteVolume >= tradeVolumePerMinute * (intervalToMs(document.getElementById('interval').value) * (parseInt(document.getElementById('limit').value) || 0) / 60000) || (t.symbol.toLowerCase() === "koge" && document.getElementById('showKoge').checked));


            tbody.innerHTML = displayList.map((t, i) => {
                const isFav = t.meanPriceRatioFactor <= meanPriceRatioThreshold &&
                    t.openVariance <= openVarianceThreshold &&
                    t.closeVariance <= closeVarianceThreshold &&
                    t.totalQuoteVolume >= tradeVolumePerMinute * (intervalToMs(document.getElementById('interval').value) * (parseInt(document.getElementById('limit').value) || 0) / 60000)
                    && t.tradeVolumeVariance <= tradeVolumeVarianceThreshold;

                return `
                    <tr data-sym="${t.sym}">
                        <td>${i + 1}</td>
                        <td title="${t.listingTimeFmt ? ('上新：' + t.listingTimeFmt) : ''}" class="star${isFav ? ' fav' : ''}">
                            ${isFav ? '★ ' : ''}
                            <img class="logo" loading="lazy" src="${t.icon}" referrerpolicy="no-referrer"
                                onerror="this.src='https://bin.bnbstatic.com/static/images/common/base-token-default.png'">
                            ${t.symbol}
                            ${t.showDaysLeft
                        ? `<span style="color:#dc2626;font-size:0.75em;margin-left:4px;">剩余${t.daysLeft.toFixed(0)}天</span>`
                        : ''
                    }
                        </td>
                        <td>${nf5.format(t.price)}</td>
                        <td>
                            <canvas id="chart-${t.sym}" width="120" height="60"></canvas>
                        </td>
                        <td>${nf0.format(t.vol24h)}</td>
                        <td class="${t.chg >= 0 ? 'up' : 'down'}">${t.chg.toFixed(2)}%</td>
                        <td>${t.totalQuoteVolume ? nf0.format(t.totalQuoteVolume) : '…'}</td>
                        <td>${t.tradeVolumeVariance ? t.tradeVolumeVariance.toFixed(5) : '…'}</td>
                        <td>${t.meanPriceRatioFactor ? t.meanPriceRatioFactor.toExponential(2) : '…'}</td>
                        <td>${t.ratioVariance ? t.ratioVariance.toExponential(2) : '…'}</td>
                        <td>${t.openVariance ? t.openVariance.toExponential(2) : '…'}</td>
                        <td>${t.closeVariance ? t.closeVariance.toExponential(2) : '…'}</td>
                        <td>${t.meanOpenPrice ? t.meanOpenPrice.toExponential(2) : '…'}</td>
                        <td>${t.meanClosePrice ? t.meanClosePrice.toExponential(2) : '…'}</td>
                        <td>${t.todayQV ? nf0.format(t.todayQV) : '…'}</td>
                        <td>${t.prevQV ? nf0.format(t.prevQV) : '…'}</td>
                    </tr>
                    `;
            }).join('');

            updateSortIcons();

            // Draw Chart.js line chart for each token (open & close)
            displayList.forEach(t => {
                const canvas = document.getElementById(`chart-${t.sym}`);
                if (!canvas || !t.klines || !t.klines.closes || t.klines.closes.length === 0 || !t.klines.opens || t.klines.opens.length === 0) return;

                // Prepare data
                const labels = t.klines.timestamps.map(ts => {
                    const d = new Date(ts);
                    return `${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
                });

                new Chart(canvas, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Open',
                                data: t.klines.opens,
                                borderColor: '#16a34a',
                                backgroundColor: 'rgba(22,163,74,0.08)',
                                fill: false,
                                tension: 0.03,
                                pointRadius: 0
                            },
                            {
                                label: 'Close',
                                data: t.klines.closes,
                                borderColor: '#2563eb',
                                backgroundColor: 'rgba(37,99,235,0.08)',
                                fill: false,
                                tension: 0.03,
                                pointRadius: 0
                            }
                        ]
                    },
                    options: {
                        responsive: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { display: false },
                            y: { display: false }
                        }
                    }
                });
            });
        }


        /* ---------- 刷新数据 ---------- */
        async function reloadAll() {
            refreshBtn.disabled = true; progressEl.textContent = '0%';
            const today8 = nearest8UTC(), yest8 = today8 - 864e5, endTs = Date.now();

            thToday.innerHTML = `当天限价单成交额<span class="subl">(${fmtShort(today8)}&nbsp;~&nbsp;${fmtShort(endTs)})</span>`;
            thPrev.innerHTML = `前一天限价单成交额<span class="subl">(${fmtShort(yest8)}&nbsp;~&nbsp;${fmtShort(today8 - 1)})</span>`;

            try {
                rows = await fetchList();
                await fillQVAll(rows, today8, yest8, endTs);  // Fetch QV data and other stats
                sortKey = 'todayQV';
                sortDir = 'desc';
                top15 = sortRows(rows).slice(0, 15)
                await fillMeanAll(top15);
                sortKey = 'meanPriceRatioFactor';
                sortDir = 'asc';
                render();  // Render after sorting
                lastUpEl.textContent = `最后更新时间： ${fmtFull(Date.now())}`;
                window._boundary = today8;
            } catch (e) {
                console.error(e);
                tbody.innerHTML = '<tr><td colspan="8">加载失败…</td></tr>';
                showToast('加载失败，请稍后重试');
            } finally {
                refreshBtn.disabled = false;
            }
        }

        /* ★ 绑定刷新按钮 */
        refreshBtn.addEventListener('click', reloadAll);

        document.querySelectorAll('th.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const key = th.dataset.key;
                sortDir = (sortKey === key && sortDir === 'desc') ? 'asc' : 'desc';
                sortKey = key;
                render();
            });
        });

        /* ---------- 自刷新 ---------- */
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible' && nearest8UTC() !== window._boundary) reloadAll();
        });
        setInterval(() => { if (document.visibilityState === 'visible') reloadAll(); }, 60000);

        /* ---------- 首次加载 ---------- */
        reloadAll();
    </script>


</body>
</html>